
{%extends 'layout.htm'%}
{%from "macro/modalmacro.htm" import modalmcr%}
{%block main%}

  <!--Main layout-->
<main class="mt-5 pt-5">
  <div class="container">

    <!--Section: Post-->
    <section class="mt-4">

      <!--Grid row-->
      <div class="row">

        <!--Grid column-->
        <div class="mb-4 col-8">

          <!--Featured Image-->
          <div class="card mb-4 wow fadeIn">

            <img src="https://mdbootstrap.com/img/Photos/Slides/img%20(144).jpg" class="img-fluid" alt="">

          </div>
          <!--/.Featured Image-->
          <script id="table-template-{{userid}}" type="text/x-handlebars-template">
            {% raw %}
              {{#each data}}  
                <tr id="{{postid}}">
                  <td>{{@index}}</td>
                  <td>{{username}}</td>
                  <td><a href="/posting/detail/{{user_id}}/postid={{postid}}">{{title}}</a></td>
                  <td>{{datefmt date_posted}}</td>

                  <td>
                  <div class="custom-control custom-checkbox ml-2">
                      <input no ="{{@index}}" type="checkbox" class="custom-control-input" id="check{{@index}}">
                      <label class="custom-control-label" for="check{{@index}}"></label>
                  </div>
                  </td>
                  <td>
                    <div class="custom-control custom-checkbox ml-2">
                        <input type="checkbox" name="delcheckbox" class="custom-control-input" id="del{{@index}}">
                        <label class="custom-control-label" for="del{{@index}}"></label>
                    </div>
                  </td>
                </tr>
              {{/each}}
            {% endraw %}
          </script>
          <div class="row float-right">
            <div>
              <button class="btn btn-info btn-md" type="button" onclick="comparetwo()"> 비교하기 </button>
            </div>
            <div>
            <a class="btn btn-info btn-md" href="/posting/write"> 글쓰기 </a>
            </div>
            {% call modalmcr('danger','delbtn', 'del','삭제하기','delconfirmmodal', '정말 삭제하시겠습니까?', 'delPost()') %}
            {% endcall%}
          </div>
          <table id="postingtable" class="table table-hover">
              <thead>
                  <tr>
                    <th scope="col">No</th>
                    <th scope="col">작성자</th>
                    <th scope="col">Title</th>
                    <th scope="col">Date</th>
                    <th scope="col">비교</th>
                    <th scope="col">삭제</th>
                  </tr>
                </thead>
                <tbody id="postingbody-{{userid}}">
                </tbody>
              </table>
            </div>
          </div>
          <!--Grid row-->
          
          <div class="row">
          <!--Card-->
            <div class="col card mb-4 wow fadeIn">
              <!--Card content-->
              <div class="card-body text-center">
                <p class="h5 my-4">비교</p>
                <p id="compare-content">비교하고 싶은 글을 최대 2개 선택해주세요.</p>
              </div>
            </div>
            <!--/.Card-->

        <!--Grid column-->
            <!-- Card -->
            <div class="card col-4 ml-4 h-auto">
              <!-- Card content -->
              <div class="card-body">
                <!-- Title -->
                <div class="md-form" id="newchecklistarea">
                  <h4 class="card-title"> 
                  <i class="fas fa-user prefix"></i>
                  <input type="text" id="newchecklist" class="form-control">
                  <label id = "newchecklistlabel" for="newchecklist"></label>
                </h4>
                <button onclick="newchecklist()" type="button" id="newchecklistbtn" class="btn btn-sm btn-default px-3 text-right">
                  <i class="fas fa-plus" aria-hidden="true"></i>
                </button>
                </div>
                <!-- Material input -->
                <div class="row">
                  <div class="md-form w-75">
                    <i class="fas fa-user prefix"></i>
                    <input type="text" id="newcheck" class="form-control">
                    <label for="newcheck">추가하기</label>
                    </div>
                    <button type="button" id="newcheckbtn" class="btn btn-sm btn-default px-3 text-right">
                      <i class="fas fa-plus" aria-hidden="true"></i>
                    </button>
                  </div>
                  <div id="checkarea">

                  </div>
                </div>


                <div class="container">
            <!-- (btnId, btnName, modalId, hId, msg, fn='') -->

                  {% call modalmcr('default float-right', 'savebtn','save', '저장하기', 'saveModal', '저장하시겠습니까?') %}
                  {%endcall%}
                </div>
              </div>
            </div>
          </div>
            <!-- Card -->


    </section>
    <!--Section: Post-->
    


</main>
<!--Main layout-->

<script>

function newchecklist() {
  var labelName = $('#newchecklist').val();
  if ($('#newchecklist').val() == '') {
    alert('체크리스트의 이름을 정해주세요!!!')
    return
  }
  $('#newchecklistarea').html('<h4>' + labelName + '</h4>')
}

var ids = 1;
$('#newcheckbtn').click( function() {
  if ($('#newchecklistarea').text().trim() == '') {
    alert("체크리스트 이름을 먼저 정해주세요")
    return
  }
  var txt = $('#newcheck').val();
  $('#newcheck').val('');
  var htmls = '<div class="custom-control custom-checkbox" id="checkboxarea' + String(ids) + '"> \
  <input type="checkbox" class="custom-control-input checknew" id="checknew' + String(ids) + '"' + '>\
  <label class="custom-control-label checknew" id="newlabel' + String(ids) + '"' + '\
  for="checknew' + String(ids) + '"></label></div>';
  $(htmls).appendTo('#checkarea')
  $('#newlabel' + String(ids)).text(txt);
  ids = ids + 1;
  $('input.checknew').change( function() {
    setYellow();
  })
});

function setYellow() {
  $('input.checknew').each(function () {
    $(this).next('label').css('background-color', 'white');
  })
  
  $('input.checknew:checked').each(function () {
    $(this).next('label').css('background-color', 'yellow');
  })
}

var savedata = {};
var savedt = []
$('#save').click( function() {
  var l = $('input.checknew').next('label').length;
  for (var i = 1; i <= l; i++) {
    savedt.push($('#newlabel' + String(i)).text())
  };
    savedata['checklist'] = savedt.join(', ');
    savedata['name'] = $('#newchecklistarea').text().trim();
  $.ajax({
    url : '/posting/save/{{userid}}',
    data : JSON.stringify(savedata),
    type : 'POST',
    contentType:"application/json",
    dataType: 'json'
    }).done( function(res) {
      if (res['status'] === 'fail') {
        alert('저장에 실패했습니다! 다시 시도해주세요')
      }
      else {
        alert('저장 성공!')
      }
      closeModal('saveModal')
    }).fail( function(res) {
      console.log("Error!!", res)
    })
})




Handlebars.registerHelper('datefmt', function (dt) {
  var m = moment(dt);
  var output = m.format("YYYY MMMM Do, a h:mm");
  return output; 
  }); 
var data = {}
var len = null;
var dataTemplate = null;

function hbs(sourceId, data, resultId) {
  var source = document.getElementById(sourceId).innerHTML;
  var template = Handlebars.compile(source);
  if (resultId === 'postingbody-{{userid}}'){
      // dataTemplate에 template( compile을 한 번만 하기 위해서 (다시 compile하지 말라는 뜻))
      dataTemplate = template;
      render(template, data, resultId)
    }    
  } 
function render(template, data, resultId) {
  document.getElementById(resultId).innerHTML = template(data);
  } 

$(document).ready(
  $.ajax({
    url : '/posting/lists/{{userid}}',
    type : 'GET' 
  }).done(function(res) {
    len = res.length;
    data = res;
    console.log("Data>>>>>>", data)
    hbs("table-template-{{userid}}", {data:data}, 'postingbody-{{userid}}')
  }).fail(function(res) {
    console.log("Error!!", res)
  })
)


var htmls = {};
function comparetwo() {
  var chckcnt = [];
  var a = 1;
  for (var k=0; k < data.length; k++) {
    if ($("input:checkbox[id='check" + String(k) + "'" + "]").is(":checked") == true) {
      chckcnt.push(k);
      console.log("chckcnt>>>>>>>", chckcnt);
    }
  }

  if (chckcnt.length < 2) {
    alert('두 개를 선택해주세요!')
    chckcnt = [];
    return
  }
  else if(chckcnt.length > 2) {
    alert('두 개만 선택해주세요!')
    $('input:checkbox[id]').prop("checked", false)
    chckcnt = [];
    return
  }
  else {
    var i;
    for (i in chckcnt) {
      console.log("iiiiiii", i)
      var j = chckcnt[i];
      var htm = data[j]['content'];
      htmls[String(a)]=htm;
      a = a + 1;
      }
    }
  $.ajax({
    url:'/posting/compare',
    data : JSON.stringify(htmls), 
    type : 'POST',
    contentType:"application/json",
    dataType: 'json'
    }).done(function (res) {
      var h = res['HTML'];
      $('#compare-content').html(h);
      $('td.diff_next').remove() 
      $('table:nth-child(2) tbody tr:nth-child(2) td:nth-child(2) table').remove()
      $('#compare-content > table:nth-child(5) > tbody > tr:nth-child(1) > th').remove()
      $('#compare-content > table:nth-child(5) > tbody > tr:nth-child(2) > td:nth-child(2) > table').remove() 
      $('#compare-content > table:nth-child(5) > tbody > tr:nth-child(2) > td:nth-child(1) > table > tbody > tr:nth-child(2) > td').text('추가됨')
      $('#compare-content > table:nth-child(5) > tbody > tr:nth-child(2) > td:nth-child(1) > table > tbody > tr:nth-child(3) > td').text('바뀜')
      $('#compare-content > table:nth-child(5) > tbody > tr:nth-child(2) > td:nth-child(1) > table > tbody > tr:nth-child(4) > td').text('삭제됨')
      $('table.diff').css('font-family', 'Arial')
      $('#compare-content > table:nth-child(5) > tbody > tr:nth-child(2)').css('text-align', 'center')
      $('#compare-content > table:nth-child(5) > tbody > tr:nth-child(2) > td:nth-child(1) > table').removeAttr('border')
      $('table[id]').attr('align','center')
      $('table[summary]').attr('align','right')
    }).fail(function(res) {
      console.log("ERRR>>>>>>", res)
    })
  }

$('#delbtn').click( function() {
  if ($('input:checkbox[name="delcheckbox"]:checked').length == 0) {
    $('#delbtn').removeAttr('data-target')
    alert("삭제할 게시물을 선택해주세요!")
    return
  }
}); 

function delPost(userid) {
  var postids = $('tr[id]')
  var cnt = []
  for (var i=0; i<data.length; i++) {
    var postid = postids[i]['id']
    if ($("input:checkbox[id='del" + String(i) + "'" + "]").is(":checked") == true){ 
      cnt.push(i)
      console.log("length>>>>>>>>", cnt.length)
      $.ajax({
          url:'/posting/delete/{{userid}}/' + postid,
          type:'DELETE'
        }).done(function(res){
          console.log("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!deleted")
          location.href='/posting'
        })
      }
    }
  }
  
  </script>


{%endblock main%}